<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schmelzdepot - Dokumenten Ersteller</title>
    
    <!-- 
      OFFLINE NUTZUNG ANLEITUNG:
      1. Für das Design (Tailwind): 
         Laden Sie die Datei herunter oder nutzen Sie eine lokale CSS Datei, wenn keine Internetverbindung besteht.
         Im Online-Modus wird das Design automatisch geladen.
      2. Für den Export (html2canvas):
         Laden Sie "html2canvas.min.js" herunter und legen Sie es im selben Ordner ab.
         Ändern Sie dann unten src="..." zu src="./html2canvas.min.js"
      3. Für Bilder:
         Die Bilder sind Platzhalter. Sie können diese im Code durch Base64-Strings ersetzen oder lokale Bilddateien verwenden.
    -->
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Custom Styles for Preview */
        .preview-wrapper {
            transform-origin: top center;
        }
        @media print {
            .no-print { display: none; }
            .print-only { display: block; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <div class="max-w-[1600px] mx-auto p-6 space-y-6 pb-20">
        <!-- Main Layout Grid -->
        <div class="grid grid-cols-1 xl:grid-cols-[400px_1fr] gap-8">
            
            <!-- EDITOR SECTION -->
            <div class="h-fit xl:sticky xl:top-6 bg-white rounded-xl border shadow-sm p-6 space-y-6 max-h-[calc(100vh-50px)] overflow-y-auto no-print">
                <div class="flex items-center gap-2 border-b pb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
                    <h2 class="text-xl font-semibold">Dokumenten-Editor</h2>
                </div>

                <!-- Document Type -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Dokumententyp</label>
                    <select id="docTypeSelect" class="w-full h-10 px-3 rounded-md border border-gray-300 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="delivery">Lieferschein</option>
                        <option value="confirmation">Bestellbestätigung</option>
                        <option value="invoice">Rechnung</option>
                    </select>
                </div>

                <hr class="border-gray-200">

                <!-- Customer Data -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between border-b pb-2">
                         <h3 class="font-semibold text-sm text-gray-500 uppercase tracking-wider">Kundendaten & Lieferung</h3>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Kunde / Firma</label>
                            <input type="text" id="customerName" placeholder="Firmenname oder Kunde" class="w-full h-10 px-3 rounded-md border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Vorgangs-Nr.</label>
                            <input type="text" id="orderNumber" placeholder="z.B. 2024-001" class="w-full h-10 px-3 rounded-md border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-sm font-medium">E-Mail Adresse</label>
                            <input type="text" id="customerEmail" placeholder="email@firma.com" class="w-full h-10 px-3 rounded-md border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Telefon / Mobil</label>
                            <input type="text" id="customerPhone" placeholder="+1 555..." class="w-full h-10 px-3 rounded-md border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-medium">Lieferadresse</label>
                        <textarea id="deliveryAddress" placeholder="Straße, Hausnummer&#10;PLZ Stadt&#10;Land" class="w-full min-h-[80px] px-3 py-2 rounded-md border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Datum</label>
                            <input type="date" id="deliveryDate" class="w-full h-10 px-3 rounded-md border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                         <div class="space-y-2">
                            <label class="text-sm font-medium">Verwendungszweck / Notiz</label>
                            <input type="text" id="paymentNote" placeholder="Optional" class="w-full h-10 px-3 rounded-md border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>
                </div>

                <!-- Items Section -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium">Positionen</label>
                        <button onclick="addItem()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                            Position
                        </button>
                    </div>
                    
                    <div id="itemsContainer" class="space-y-2">
                        <!-- Items will be injected here via JS -->
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-3 pt-4">
                    <button onclick="exportAsPNG()" class="flex-1 inline-flex items-center justify-center rounded-md text-sm font-medium bg-black text-white hover:bg-gray-800 h-10 px-4 py-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        Als PNG exportieren
                    </button>
                    <button onclick="resetForm()" class="inline-flex items-center justify-center rounded-md text-sm font-medium border border-input bg-background hover:bg-accent h-10 w-10">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74-2.74L3 12"/></svg>
                    </button>
                </div>
            </div>

            <!-- PREVIEW SECTION -->
            <div class="space-y-2 flex justify-center bg-gray-100/50 p-8 rounded-xl border overflow-auto">
                <div class="preview-wrapper" style="transform: scale(0.8); width: 949px; min-height: 1200px;">
                    <div id="previewCanvas" style="width: 949px; min-height: auto; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; font-family: Arial, sans-serif;">
                        
                        <!-- Header Image -->
                        <div id="headerImageContainer" class="w-full">
                            <!-- Image injected by JS -->
                            <div class="w-full h-32 bg-gray-200 flex items-center justify-center text-gray-400">
                                HEADER BILD (Lokal speichern für Offline)
                            </div>
                        </div>

                        <!-- Customer Info -->
                        <div style="border-bottom: 2px solid #e5e7eb; display: grid; grid-template-columns: 1fr 1fr; flex-shrink: 0;">
                            <div style="padding: 32px; border-right: 2px solid #e5e7eb;">
                                <div style="margin-bottom: 20px;">
                                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Kundenname</div>
                                    <div id="prevCustomerName" style="font-size: 20px; font-weight: bold; color: #111827;">-</div>
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">E-Mail</div>
                                    <div id="prevEmail" style="font-size: 18px; color: #111827;">-</div>
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Telefon</div>
                                    <div id="prevPhone" style="font-size: 18px; color: #111827;">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Lieferadresse</div>
                                    <div id="prevAddress" style="font-size: 18px; color: #111827; white-space: pre-line;">-</div>
                                </div>
                            </div>
                            
                            <div style="padding: 32px;">
                                <div style="margin-bottom: 20px;">
                                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Dokumententyp</div>
                                    <div id="prevDocTitle" style="font-size: 24px; font-weight: bold; color: #ff8000; text-transform: uppercase;">LIEFERSCHEIN</div>
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Vorgangsnummer</div>
                                    <div id="prevOrderNumber" style="font-size: 20px; font-weight: bold; color: #111827;">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Datum</div>
                                    <div id="prevDate" style="font-size: 18px; color: #111827;">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Table -->
                        <div style="padding: 32px; flex: 1; min-height: 600px; display: flex; flex-direction: column;">
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 32px;">
                                <thead>
                                    <tr style="background-color: #ff8000; color: #ffffff;">
                                        <th style="text-align: left; padding: 16px 12px; font-size: 16px; font-weight: bold;">ARTIKEL</th>
                                        <th style="text-align: center; padding: 16px 12px; font-size: 16px; font-weight: bold;">MENGE</th>
                                        <th class="price-col" style="text-align: right; padding: 16px 12px; font-size: 16px; font-weight: bold;">PREIS</th>
                                        <th class="price-col" style="text-align: right; padding: 16px 12px; font-size: 16px; font-weight: bold;">GESAMT</th>
                                    </tr>
                                </thead>
                                <tbody id="previewTableBody">
                                    <!-- Rows -->
                                </tbody>
                            </table>

                            <!-- Summary -->
                            <div id="summarySection" style="margin-top: auto; padding-top: 24px; border-top: 2px solid #e5e7eb; display: none;">
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 16px;">
                                    <span style="color: #6b7280;">Zwischensumme</span>
                                    <span style="font-weight: bold; color: #111827;" id="valSub">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 16px;">
                                    <span style="color: #6b7280;">Steuer (+5%)</span>
                                    <span style="font-weight: bold; color: #111827;" id="valTax">-</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 20px; margin-top: 20px; border-top: 3px solid #111827; font-size: 22px; font-weight: bold;">
                                    <span style="color: #111827;">Erwartete Summe</span>
                                    <span style="color: #ff8000;" id="valTotal">-</span>
                                </div>
                            </div>
                            
                            <div id="deliverySpacer" style="margin-top: auto; padding-top: 24px;"></div>
                        </div>

                        <!-- Footer -->
                        <div style="background-color: #ff8000; color: #ffffff; padding: 32px; display: flex; flex-direction: column; gap: 12px; flex-shrink: 0; margin-top: auto;">
                            <div id="footerDelivery" style="display: block;">
                                <p style="font-size: 16px; font-weight: bold; letter-spacing: 0.5px; margin: 0;">
                                    LITTLE SEOUL WEST 121 · SA, LOS SANTOS · SCHMELZDEPOT@STATEV.DE
                                </p>
                                <div style="font-size: 14px; line-height: 1.5; opacity: 0.95;">
                                    <p>Ware bleibt bis zur vollständigen Bezahlung Eigentum des Schmelzdepots.</p>
                                    <p>Bitte prüfen Sie die Ware sofort auf Vollständigkeit und Unversehrtheit.</p>
                                    <p style="margin-top: 10px; font-weight: bold;">Vielen Dank für Ihr Vertrauen!</p>
                                </div>
                            </div>
                            
                            <div id="footerInvoice" style="display: none;">
                                <p style="font-size: 16px; font-weight: bold; letter-spacing: 0.5px; margin: 0;">
                                    LITTLE SEOUL WEST 121 · SA, LOS SANTOS · SCHMELZDEPOT@STATEV.DE
                                </p>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <span style="font-size: 18px; font-weight: bold;">Vielen Dank für Ihre Bestellung!</span>
                                    <span style="font-size: 14px; opacity: 0.9;">
                                        Hinweis: Dies ist keine Rechnung. Die Zahlung erfolgt erst nach Erhalt der offiziellen Rechnung. 
                                        Die aufgeführten Preise dienen lediglich als vorläufiger Kostenvoranschlag.
                                    </span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Placeholders for images. Replace with Base64 strings for true offline use.
        const HEADER_IMG_STANDARD = "https://placehold.co/949x200/png?text=Standard+Header"; 
        const HEADER_IMG_TRUCK = "https://placehold.co/949x200/orange/white/png?text=Delivery+Header";

        // --- STATE ---
        let state = {
            docType: 'delivery',
            customer: {
                name: '',
                email: '',
                phone: '',
                address: '',
                orderNumber: '',
                date: new Date().toISOString().split('T')[0],
                note: ''
            },
            items: []
        };

        const formatter = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderItems();
            updatePreview();
            
            // Listeners
            document.getElementById('docTypeSelect').addEventListener('change', (e) => {
                state.docType = e.target.value;
                updatePreview();
            });
            
            ['customerName', 'customerEmail', 'customerPhone', 'orderNumber', 'deliveryDate', 'paymentNote'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    const key = id.replace('customer', '').replace('delivery', '').replace('payment', '');
                    const map = {
                        'Name': 'name', 'Email': 'email', 'Phone': 'phone', 
                        'Date': 'date', 'Note': 'note', 'orderNumber': 'orderNumber'
                    };
                    // Simplified mapping
                    if(id === 'orderNumber') state.customer.orderNumber = e.target.value;
                    else if(id === 'deliveryDate') state.customer.date = e.target.value;
                    else if(id === 'paymentNote') state.customer.note = e.target.value;
                    else if(id === 'customerName') state.customer.name = e.target.value;
                    else if(id === 'customerEmail') state.customer.email = e.target.value;
                    else if(id === 'customerPhone') state.customer.phone = e.target.value;
                    
                    updatePreview();
                });
            });

            document.getElementById('deliveryAddress').addEventListener('input', (e) => {
                state.customer.address = e.target.value;
                updatePreview();
            });
            
            // Set initial date
            document.getElementById('deliveryDate').value = state.customer.date;
        });

        // --- LOGIC ---
        function addItem() {
            state.items.push({ name: '', qty: 1, price: 0 });
            renderItems();
            updatePreview();
        }

        function removeItem(index) {
            state.items.splice(index, 1);
            renderItems();
            updatePreview();
        }

        function updateItem(index, field, value) {
            state.items[index][field] = value;
            updatePreview();
        }

        function renderItems() {
            const container = document.getElementById('itemsContainer');
            container.innerHTML = '';
            
            if (state.items.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-400 text-center py-4 border border-dashed rounded-lg">Keine Positionen</p>';
                return;
            }

            state.items.forEach((item, idx) => {
                const row = document.createElement('div');
                row.className = 'flex gap-2 items-end';
                row.innerHTML = `
                    <div class="flex-[2]">
                        <input type="text" value="${item.name}" oninput="updateItem(${idx}, 'name', this.value)" placeholder="Artikel" class="w-full h-10 px-3 rounded-md border border-gray-300 text-sm">
                    </div>
                    <div class="w-20">
                        <input type="number" value="${item.qty}" oninput="updateItem(${idx}, 'qty', parseInt(this.value)||0)" placeholder="Menge" class="w-full h-10 px-3 rounded-md border border-gray-300 text-sm">
                    </div>
                    <div class="w-24">
                        <input type="number" value="${item.price}" oninput="updateItem(${idx}, 'price', parseFloat(this.value)||0)" placeholder="Preis" class="w-full h-10 px-3 rounded-md border border-gray-300 text-sm">
                    </div>
                    <button onclick="removeItem(${idx})" class="h-10 w-10 flex items-center justify-center text-red-500 hover:bg-red-50 rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    </button>
                `;
                container.appendChild(row);
            });
        }

        function updatePreview() {
            // Header Image
            const isTruck = state.docType === 'delivery' || state.docType === 'confirmation';
            const imgUrl = isTruck ? HEADER_IMG_TRUCK : HEADER_IMG_STANDARD;
            document.getElementById('headerImageContainer').innerHTML = `<img src="${imgUrl}" style="width: 100%; height: auto; display: block;">`;

            // Text Fields
            document.getElementById('prevCustomerName').textContent = state.customer.name || '-';
            document.getElementById('prevEmail').textContent = state.customer.email || '-';
            document.getElementById('prevPhone').textContent = state.customer.phone || '-';
            document.getElementById('prevAddress').textContent = state.customer.address || '-';
            document.getElementById('prevOrderNumber').textContent = state.customer.orderNumber || '-';
            document.getElementById('prevDate').textContent = state.customer.date ? new Date(state.customer.date).toLocaleDateString('de-DE') : '-';

            // Doc Title
            let title = 'LIEFERSCHEIN';
            if(state.docType === 'invoice') title = 'RECHNUNG';
            if(state.docType === 'confirmation') title = 'BESTELLBESTÄTIGUNG';
            document.getElementById('prevDocTitle').textContent = title;

            // Visibility of Price Columns and Footer
            const isDelivery = state.docType === 'delivery';
            const priceCols = document.querySelectorAll('.price-col');
            priceCols.forEach(el => el.style.display = isDelivery ? 'none' : 'table-cell');

            document.getElementById('summarySection').style.display = isDelivery ? 'none' : 'block';
            document.getElementById('deliverySpacer').style.display = isDelivery ? 'block' : 'none';

            document.getElementById('footerDelivery').style.display = isDelivery ? 'block' : 'none';
            document.getElementById('footerInvoice').style.display = isDelivery ? 'none' : 'block'; // Confirmation uses invoice footer logic for text, but truck header

            // Table Rows
            const tbody = document.getElementById('previewTableBody');
            tbody.innerHTML = '';
            
            let subtotal = 0;

            state.items.forEach((item, index) => {
                const total = item.price * item.qty;
                subtotal += total;
                
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #e5e7eb';
                tr.style.backgroundColor = index % 2 === 0 ? '#ffffff' : '#f9fafb';
                
                let html = `
                    <td style="padding: 14px 12px; font-size: 16px; color: #111827;">${item.name}</td>
                    <td style="padding: 14px 12px; text-align: center; font-size: 16px; color: #111827;">${item.qty}</td>
                `;
                
                if(!isDelivery) {
                    html += `
                        <td style="padding: 14px 12px; text-align: right; font-size: 16px; color: #111827;">${formatter.format(item.price)}</td>
                        <td style="padding: 14px 12px; text-align: right; font-size: 16px; font-weight: bold; color: #111827;">${formatter.format(total)}</td>
                    `;
                }
                
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });

            // Totals
            const tax = subtotal * 0.05;
            const net = subtotal + tax;
            
            document.getElementById('valSub').textContent = formatter.format(subtotal);
            document.getElementById('valTax').textContent = '+' + formatter.format(tax);
            document.getElementById('valTotal').textContent = formatter.format(net);
        }

        function resetForm() {
            state.customer = { name: '', email: '', phone: '', address: '', orderNumber: '', date: new Date().toISOString().split('T')[0], note: '' };
            state.items = [];
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('deliveryAddress').value = '';
            document.getElementById('orderNumber').value = '';
            document.getElementById('paymentNote').value = '';
            renderItems();
            updatePreview();
        }

        async function exportAsPNG() {
            const element = document.getElementById('previewCanvas');
            if(!element) return;
            
            if (typeof html2canvas === 'undefined') {
                alert('html2canvas Bibliothek nicht gefunden! Bitte stellen Sie sicher, dass eine Internetverbindung besteht oder die Bibliothek lokal eingebunden ist.');
                return;
            }

            try {
                // Temporarily remove transform
                const wrapper = element.parentElement;
                const originalTransform = wrapper.style.transform;
                wrapper.style.transform = 'none';

                const canvas = await html2canvas(element, {
                    scale: 1,
                    backgroundColor: '#ffffff',
                    useCORS: true
                });

                // Restore transform
                wrapper.style.transform = originalTransform;

                const link = document.createElement('a');
                link.download = `${state.docType}_${state.customer.orderNumber || 'DRAFT'}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (err) {
                console.error(err);
                alert('Export Fehler: ' + err.message);
            }
        }
    </script>
</body>
</html>